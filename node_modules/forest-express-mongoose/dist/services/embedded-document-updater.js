"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));
var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));
var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));
var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));
var EmbeddedDocumentUpdater = /*#__PURE__*/function () {
  function EmbeddedDocumentUpdater(model, params, association, record) {
    (0, _classCallCheck2["default"])(this, EmbeddedDocumentUpdater);
    this._model = model;
    this._params = params;
    this._association = association;
    this._record = record;
  }
  return (0, _createClass2["default"])(EmbeddedDocumentUpdater, [{
    key: "perform",
    value: function () {
      var _perform = (0, _asyncToGenerator2["default"])( /*#__PURE__*/_regenerator["default"].mark(function _callee() {
        var _this = this;
        var recordId, recordIndex, update;
        return _regenerator["default"].wrap(function _callee$(_context) {
          while (1) switch (_context.prev = _context.next) {
            case 0:
              recordId = this._params.recordId;
              recordIndex = parseInt(this._params.recordIndex, 10);
              delete this._record._id;
              update = Object.keys(this._record).reduce(function (acc, value) {
                acc.$set["".concat(_this._association, ".").concat(recordIndex, ".").concat(value)] = _this._record[value];
                return acc;
              }, {
                $set: {}
              });
              return _context.abrupt("return", this._model.findByIdAndUpdate(recordId, update));
            case 5:
            case "end":
              return _context.stop();
          }
        }, _callee, this);
      }));
      function perform() {
        return _perform.apply(this, arguments);
      }
      return perform;
    }()
  }]);
}();
module.exports = EmbeddedDocumentUpdater;